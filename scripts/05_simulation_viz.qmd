---
title: "Uncertainty is central to reliable inference"
subtitle: "Simulation Study Visualizations"
author: 
 - name: Bj√∂rn S. Siepe
   orcid: 0000-0002-9558-4648
   affiliations: University of Marburg
 - name: Matthias Kloft
   orcid: 0000-0003-1845-6957
   affiliations: University of Marburg  
 - name: Daniel W. Heck
   orcid: 0000-0002-6302-9252
   affiliations: University of Marburg
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: true
    code-tools: true
    code-summary: "Show the code"
    fig-width: 7
    fig-height: 4.5
    fig-align: "center"
    embed-resoureces: true
execute:
  message: false
  warning: false
---

# Background

This document contains code to reproduce the visualizations of the simulation study in the manuscript. It also contains additional results not shown in the main manuscript. 

# Preparation

Load relevant packages:

```{r}
library(tidyverse)
library(here)
library(cowplot)
library(ggh4x)
library(ggokabeito)
library(pander)
source(here::here("scripts", "00_functions.R"))
```

Load the simulation results: 
```{r}
sim_results <- readRDS(here("sim120924.rds"))

# Create a cut version of the simulation results without MCMC diagnostics
sim_res_cut <- sim_results |>
  select(-contains("rhat")) |>
  select(-contains("divtrans"))
```





## Data Wrangling

Prepare dataframe for visualization by giving proper names, removing unnecessary columns, and pivoting longer:
```{r}
sr_edit <- sim_res_cut |> 
  mutate(dgp = factor(dgp, levels = c("dense", "sparse")),
         heterogeneity = factor(heterogeneity, levels = c("low", "high"))) |>
  # remove "reg_" from all column names
  rename_with(~str_remove(., "reg_")) |> 
  # remove everything before a "." in the column names
  rename_with(~str_remove(., ".*\\.")) |> 
  dplyr::select(-c("REPLICATIONS", "SIM_TIME", "SEED", "COMPLETED", "WARNINGS", "RAM_USED")) |> 
  # pivot longer except conditions cols
  pivot_longer(cols = -c("dgp", "heterogeneity", "n_tp"), 
               names_to = "measure", 
               values_to = "value") |> 
  mutate(measure = str_replace(measure, "power_reg", "powerreg"),
         measure = str_replace(measure, "powertwoside_reg", "powertwosidereg"),
         measure = str_replace(measure, "poweroneside_reg", "poweronesidereg"),
         measure = str_replace(measure, "rmse_reg", "rmsereg"),
         measure = str_replace(measure, "mse_reg", "msereg")) |>
  separate_wider_delim(measure, 
                       delim = "_",
                       names = c("pm", "outcome", "method", "summary")) |> 
  mutate(method = case_when(
    method == "gvar" ~ "GVAR",
    method == "gimme" ~ "GIMME",
    method == "mlvar" ~ "mlVAR",
    method == "bmlvar" ~ "BmlVAR"
  )) |>
  # treat method as factor and order 
  mutate(method = factor(method, levels = c("GVAR", "GIMME", "mlVAR", "BmlVAR"))) |>
  mutate(outcome = case_when(
    outcome == "beta" ~ "Temporal",
    outcome == "pcor" ~ "Contemporaneous",
    .default = outcome
  )) |>
  group_by(dgp, heterogeneity, pm, outcome, method) |>
  pivot_wider(names_from = summary, values_from = value) |> 
  ungroup()



```


Prepare different colors and settings for visualization: 
```{r viz-prep}
meth_colors <- ggokabeito::palette_okabe_ito()[c(5, 1, 2, 3)]

```


# Check Warnings and Non-Convergence
Check if any non-convergence occured:
```{r sim-errors}

```



# Point Estimates

Plot point estimate recovery (RMSE), not directly relevant for the manuscript, but maybe helpful to understand the overall performance of the different methods.

```{r viz-point-estimates}
plot_mse <- sr_edit |> 
  mutate(mcse = ifelse(is.na(mcse), 0, mcse)) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  filter(pm == "mse") |> 
  ggplot(aes(x = method, 
             y = mean, 
             colour = method
             )) +
  # add horizontal line between methods
  geom_vline(colour = "#F3F4F5", xintercept = seq(1.5, 4, 1))+
  geom_errorbar(aes(ymin = mean - 1*mcse,
                            ymax = mean + 1*mcse),
                        width = .8,
                 position = position_dodge(0.7),
                 show.legend = FALSE)+
  geom_point(position = position_dodge(0.7), 
             size = 1.2) +
  ggh4x::facet_nested(dgp ~ outcome + n_tp,
                      axes = "all",
                      remove_labels = "y") +
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_y_continuous(expand = c(0, 0), limits = c(0,0.03)) +
  scale_color_manual(values = meth_colors) +
  theme_centrality() +
  theme(legend.position = "none",
        text = element_text(size = 22))+
  labs(title = "",
       x = "Method",
       colour = "Method",
       y = "MSE of Network Estimation")

plot_mse

```

Plot Bias:

```{r viz-bias}
plot_bias <- sr_edit |> 
  mutate(mcse = ifelse(is.na(mcse), 0, mcse)) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  filter(pm == "bias") |> 
  ggplot(aes(x = method, 
             y = mean, 
             colour = method
             )) +
  # add horizontal line between methods
  geom_vline(colour = "#F3F4F5", xintercept = seq(1.5, 4, 1))+
  geom_errorbar(aes(ymin = mean - 1*mcse,
                            ymax = mean + 1*mcse),
                        width = .8,
                 position = position_dodge(0.7),
                 show.legend = FALSE)+
  geom_point(position = position_dodge(0.7), 
             size = 1.2) +
  ggh4x::facet_nested(dgp ~ outcome + n_tp,
                      axes = "all",
                      remove_labels = "y") +
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_y_continuous(expand = c(0, 0), limits = c(-0.05,0.1)) +
  scale_color_manual(values = meth_colors) +
  theme_centrality() +
  theme(legend.position = "none",
        text = element_text(size = 22))+
  labs(title = "",
       x = "Method",
       colour = "Method",
       y = "Bias of Network Estimation")

plot_bias
```




# Centrality

## Plot most central identical 

```{r viz-most-central}
plot_mostcentral <- sr_edit |> 
  # if mcse is missing, set to 0
  mutate(mcse = ifelse(is.na(mcse), 0, mcse)) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  filter(pm == "mostcent") |> 
  ggplot(aes(x = method, 
             y = mean, 
             colour = method
             )) +
  # add horizontal line between methods
  geom_vline(colour = "#F3F4F5", xintercept = seq(1.5, 4, 1))+
  geom_errorbar(aes(ymin = mean - 1*mcse,
                            ymax = mean + 1*mcse),
                        width = .8,
                 position = position_dodge(0.7),
                 show.legend = FALSE)+
  geom_point(position = position_dodge(0.7), 
             size = 1.2) +
  ggh4x::facet_nested(dgp ~ outcome + n_tp,
                      axes = "all",
                      remove_labels = "y") +
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_y_continuous(expand = c(0, 0), limits = c(0,1.1)) +
  scale_color_manual(values = meth_colors) +
  theme_centrality() +
  theme(legend.position = "none",
        text = element_text(size = 22))+
  labs(title = "",
       x = "Method",
       colour = "Method",
       y = "Proportion of Correct Central Nodes")

# ggsave("plot_mostcentral_mock.svg", plot_mostcentral, height = 5, width = 9,
       # path = here::here("figures/"), device = "svg")

plot_mostcentral

```


## Plot rank correlation of centrality measures

```{r viz-rank-correlation}
plot_rankcor <- sr_edit |> 
  # if mcse is missing, set to 0
  mutate(mcse = ifelse(is.na(mcse), 0, mcse)) |>
  # uselessly used temp and cont instead of beta and pcor here
  mutate(outcome = case_when(
    outcome == "temp" ~ "Temporal",
    outcome == "cont" ~ "Contemporaneous"
  )) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  filter(pm == "rankcor") |> 
  ggplot(aes(x = method, 
             y = mean, 
             colour = method
             )) +
  # add horizontal line between methods
  geom_vline(colour = "#F3F4F5", xintercept = seq(1.5, 4, 1))+
  geom_errorbar(aes(ymin = mean - 1*mcse,
                            ymax = mean + 1*mcse),
                        width = .8,
                 position = position_dodge(0.7),
                 show.legend = FALSE)+
  geom_point(position = position_dodge(0.7), 
             size = 1.2) +
  ggh4x::facet_nested(dgp ~ outcome + n_tp,
                      axes = "all",
                      remove_labels = "y") +
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_y_continuous(expand = c(0, 0), limits = c(0,1.1)) +
  scale_color_manual(values = meth_colors) +
  theme_centrality() +
  theme(legend.position = "none",
        text = element_text(size = 22))+
  labs(title = "",
       x = "Method",
       colour = "Method",
       y = "Centrality Rank Correlation")


plot_rankcor


``` 
mlVAR seems to be horrible here.

# Regression

Need to find a way to nest the different strengths of regression coefficient

## Power of Regression
Prep data
```{r viz-regression-power-prep}
# Split data set into three based on true effect
power_df <- sr_edit |> 
  filter(!str_detect(pm, "poweroneside")) |> 
  mutate(pm = str_replace(pm, "powertwoside", "power")) |> 
  filter(str_detect(pm, "power")) |> 
  mutate(outcome = case_when(
    outcome == "tempdens" ~ "Temporal\nDensity",
    outcome == "contdens" ~ "Contemporaneous\nDensity",
    outcome == "outstrength" ~ "Temporal\nOutstrength",
    outcome == "strength" ~ "Contemporaneous\nStrength",
    outcome == "instrength" ~ "Temporal\nInstrength"
  )) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  # split pm into two columns, take last number into new column
  separate_wider_delim(pm, delim = "reg", names = c("pm", "true_effect"))

power_list <- split(power_df, power_df$true_effect)
```

Function to create the plots: 

```{r viz-regression-fn}
# Function to create the plot for a given dataframe
power_plot <- function(df) {
  ggplot(df, aes(x = method, 
                 y = mean, 
                 colour = method,
                 fill = method,
                 group = method)) +
    geom_errorbar(aes(ymin = mean - 1 * mcse,
                      ymax = mean + 1 * mcse),
                  width = 0.8,
                  position = position_dodge(0.7),
                  show.legend = FALSE) +
    geom_point(position = position_dodge(0.7), 
               size = 1.2) +
    ggh4x::facet_nested(dgp ~ outcome + n_tp,
                        axes = "all",
                        remove_labels = "y") +
    scale_x_discrete(guide = guide_axis(angle = 90)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.4)) +
    scale_color_manual(values = meth_colors) +
    theme_centrality() +
    theme(legend.position = "none",
          strip.text.x.top = ggplot2::element_text(size = rel(0.85)),
          ggh4x.facet.nestline = element_line(colour = "#6d6d6e")) +
    labs(title = "",
         x = "",
         colour = "Method",
         y = "Detection Rate")
}

```


Create the plots and combine them with patchwork
```{r viz-regression-power-combined}
plot_power_list <- lapply(power_list, power_plot)

plot_power_combined <- cowplot::plot_grid(plotlist = plot_power_list, ncol = 1,
                                          labels = c("True Effect: 0", 
                                                     "True Effect: 0.2",
                                                     "True Effect: 0.4"))

ggsave("plot_power_combined_prelim.pdf", plot_power_combined, height = 12, width = 16,
       path = here::here("figures/"))

plot_power_combined

```


## RMSE of Regression

```{r viz-regression-rmse}
rmse_df <- sr_edit |> 
  filter(str_detect(pm, "rmsereg")) |> 
  mutate(outcome = case_when(
    outcome == "tempdens" ~ "Temporal\nDensity",
    outcome == "contdens" ~ "Contemporaneous\nDensity",
    outcome == "outstrength" ~ "Temporal\nOutstrength",
    outcome == "strength" ~ "Contemporaneous\nStrength",
    outcome == "instrength" ~ "Temporal\nInstrength"
  )) |>
  mutate(heterogeneity = case_when(
    heterogeneity == "low" ~ "Low\nHeterogeneity",
    heterogeneity == "high" ~ "High\nHeterogeneity"
  )) |>
  mutate(dgp = case_when(
    dgp == "dense" ~ "Non-Sparse",
    dgp == "sparse" ~ "Sparse"
  )) |>
  # split pm into two columns, take last number into new column
  separate_wider_delim(pm, delim = "reg", names = c("pm", "true_effect"))

rmse_list <- split(rmse_df, rmse_df$true_effect)
```

Function to create the plots: 
```{r viz-rmse-function}
plot_rmse <- function(df){
  ggplot(data = df,
         aes(
           x = method,
           y = mean,
           colour = method,
           fill = method,
           group = method
         )) +
    geom_errorbar(
      aes(ymin = mean - 1 * mcse, ymax = mean + 1 * mcse),
      width = .8,
      position = position_dodge(0.7),
      show.legend = FALSE
    ) +
    geom_point(position = position_dodge(0.7), size = 1.2) +
    ggh4x::facet_nested(dgp ~ outcome + n_tp,
                        axes = "all",
                        remove_labels = "y") +
    scale_x_discrete(guide = guide_axis(angle = 90)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1)) +
    scale_color_manual(values = meth_colors) +
    theme_centrality() +
    theme(
      legend.position = "none",
      strip.text.x.top = ggplot2::element_text(size = rel(0.85)),
      ggh4x.facet.nestline = element_line(colour = "#6d6d6e")
    ) +
    labs(
      title = "",
      x = "",
      colour = "Method",
      y = "RMSE"
    )
}
```

Create and combine Plots:
```{r plot-rmsereg-combined}
plot_rmse_list <- lapply(rmse_list, plot_rmse)

plot_rmse_combined <- cowplot::plot_grid(plotlist = plot_rmse_list, 
                                         ncol = 1,
                                        labels = c("True Effect: 0", 
                                                   "True Effect: 0.2",
                                                   "True Effect: 0.4"))
ggsave("plot_reg_rmse_combined_prelim.pdf", plot_rmse_combined, height = 12, width = 16,
       path = here::here("figures/"))

plot_rmse_combined

```




# MCMC Diagnostics
We can now look at the Bayesian models in more detail and check if the Rhats are satisfactory, as well as if there were any divergent transitions.

First, look at Rhats:
```{r viz-rhat}
sim_results |> 
  select(bmlvar_diagnostics.rhat_bmlvar_mean) |> 
  rename("Mean Rhat" = bmlvar_diagnostics.rhat_bmlvar_mean) |> 
  knitr::kable()
```

Second, were there any divergent transitions:
```{r check-divtrans}
sim_results |> 
  select(contains("divtrans")) |> 
  rename_with(~ str_remove(., "bmlvar_diagnostics."), everything()) |> 
  # rename(
  #   "Mean Number of\nDivTrans" = divtrans_bmlvar_mean,
  #   "Sum of\nDivTrans" = divtrans_bmlvar_sum,
  #   "Number of Models\nwith Divtrans" = divtrans_bmlvar_sumnonz
  # ) |> 
  knitr::kable(col.names = c("Mean Number of DivTrans",
                            "Sum of DivTrans",
                            "Models with Divtrans"))
```




# Create Overview Table for Supplement
Create one long overview table over all performance measures for the supplement.
Probably will be long and unwieldy. 

```{r overview-table}

``` 


# Session Info

```{r session-info}
pander::pander(sessionInfo())
```



